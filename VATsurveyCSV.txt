Option Explicit

Dim lastRowVerkopen As Integer, lastRowAankopen As Integer, EachRow As Integer, RowToTest As Integer

Sub CSV()

Application.ScreenUpdating = False
Application.DisplayAlerts = False

Worksheets("verkopen").Activate
With Range("E:L")
    .Value = .Value
End With
lastRowVerkopen = Cells(Rows.Count, "G").End(xlUp).Row

'sorteren verkopen
ActiveWorkbook.Worksheets("verkopen").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("verkopen").Sort.SortFields.Add Key:= _
        Range("K4:K" & lastRowVerkopen), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption _
        :=xlSortNormal
    ActiveWorkbook.Worksheets("verkopen").Sort.SortFields.Add Key:= _
        Range("F4:F" & lastRowVerkopen), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption _
        :=xlSortNormal
    With ActiveWorkbook.Worksheets("verkopen").Sort
        .SetRange Range("E3:L" & lastRowVerkopen)
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With

'subtotalen verkopen
Range("M3").Value = "Subtotalen"
For EachRow = Cells(Rows.Count, "G").End(xlUp).Row To 4 Step -1
    Range("M" & EachRow).Value = Range("J" & EachRow).Value & " " & Range("F" & EachRow).Value
Next

Range("E3:M" & lastRowVerkopen).Select
    Range(Selection, Selection.End(xlDown)).Select
    Selection.Subtotal GroupBy:=9, Function:=xlSum, TotalList:=Array(4), _
        Replace:=True, PageBreaks:=False, SummaryBelowData:=True

'verwijder laatste totaalrij
lastRowVerkopen = Cells(Rows.Count, "M").End(xlUp).Row
Rows(lastRowVerkopen).EntireRow.Delete

'kopieer gegevens naar subtotaalrijen
lastRowVerkopen = Cells(Rows.Count, "M").End(xlUp).Row
Range("E3:M" & lastRowVerkopen).Select
Selection.SpecialCells(xlCellTypeBlanks).Select
Selection.FormulaR1C1 = "=R[-1]C"

'gekopieerde cellen converteren naar waarden
With Range("E:M")
    .Value = .Value
End With

'rijen zonder totalen verwijderen
For RowToTest = Cells(Rows.Count, "M").End(xlUp).Row To 4 Step -1
    If InStr(1, Range("M" & RowToTest).Value, "Totaal", vbTextCompare) <> 1 Then
        Rows(RowToTest).EntireRow.Delete
    End If
Next

'sorteren aankopen
Worksheets("aankopen").Activate
With Range("E:L")
    .Value = .Value
End With
lastRowAankopen = Cells(Rows.Count, "G").End(xlUp).Row

ActiveWorkbook.Worksheets("aankopen").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("aankopen").Sort.SortFields.Add Key:= _
        Range("J4:J" & lastRowAankopen), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption _
        :=xlSortNormal
    ActiveWorkbook.Worksheets("aankopen").Sort.SortFields.Add Key:= _
        Range("E4:E" & lastRowAankopen), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption _
        :=xlSortNormal
    With ActiveWorkbook.Worksheets("aankopen").Sort
        .SetRange Range("D3:K" & lastRowAankopen)
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With

'subtotalen aankopen
Range("L3").Value = "Subtotalen"
For EachRow = Cells(Rows.Count, "F").End(xlUp).Row To 4 Step -1
    Range("L" & EachRow).Value = Range("I" & EachRow).Value & " " & Range("E" & EachRow).Value
Next

Range("D3:M" & lastRowAankopen).Select
    Range(Selection, Selection.End(xlDown)).Select
    Selection.Subtotal GroupBy:=9, Function:=xlSum, TotalList:=Array(4), _
        Replace:=True, PageBreaks:=False, SummaryBelowData:=True

'verwijder laatste totaalrij
lastRowAankopen = Cells(Rows.Count, "L").End(xlUp).Row
Rows(lastRowAankopen).EntireRow.Delete

'kopieer gegevens naar subtotaalrijen
lastRowAankopen = Cells(Rows.Count, "L").End(xlUp).Row
Range("D3:L" & lastRowVerkopen).Select
Selection.SpecialCells(xlCellTypeBlanks).Select
Selection.FormulaR1C1 = "=R[-1]C"

'gekopieerde cellen converteren naar waarden
With Range("D:L")
    .Value = .Value
End With

'rijen zonder totalen verwijderen
For RowToTest = Cells(Rows.Count, "L").End(xlUp).Row To 4 Step -1
    If InStr(1, Range("L" & RowToTest).Value, "Totaal", vbTextCompare) <> 1 Then
        Rows(RowToTest).EntireRow.Delete
    End If
Next

'add CSV sheet
Worksheets.Add(After:=Worksheets(Worksheets.Count)).Name = "CSV"

Application.ScreenUpdating = True
Application.DisplayAlerts = True

End Sub
