Option Explicit

Dim lastRowVerkopen As Integer, lastRowAankopen As Integer

Sub CSV()

Worksheets("verkopen").Activate
lastRowVerkopen = Cells(Rows.Count, "G").End(xlUp).Row

'sorteren verkopen
ActiveWorkbook.Worksheets("verkopen").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("verkopen").Sort.SortFields.Add Key:= _
        Range("K4:K" & lastRowVerkopen), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption _
        :=xlSortNormal
    ActiveWorkbook.Worksheets("verkopen").Sort.SortFields.Add Key:= _
        Range("F4:F" & lastRowVerkopen), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption _
        :=xlSortNormal
    With ActiveWorkbook.Worksheets("verkopen").Sort
        .SetRange Range("E3:L" & lastRowVerkopen)
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    
'subtotalen verkopen
Range("M3").Value = "Subtotalen"
For EachRow = Cells(Rows.Count, "G").End(xlUp).Row To 4 Step -1
    Range("M" & EachRow).Value = Range("J" & EachRow).Value & " " & Range("F" & EachRow).Value
Next

Range("E3:M" & lastRowVerkopen).Select
    Range(Selection, Selection.End(xlDown)).Select
    Selection.Subtotal GroupBy:=9, Function:=xlSum, TotalList:=Array(4), _
        Replace:=True, PageBreaks:=False, SummaryBelowData:=True
        
lastRowVerkopen = Cells(Rows.Count, "M").End(xlUp).Row
Rows(lastRowVerkopen).EntireRow.Delete

lastRowVerkopen = Cells(Rows.Count, "M").End(xlUp).Row
Range("A3:M" & lastRowVerkopen).Select
Selection.SpecialCells(xlCellTypeBlanks).Select
Selection.FormulaR1C1 = "=R[-1]C"

For RowToTest = Cells(Rows.Count, "M").End(xlUp).Row To 4 Step -1
    If InStr(1, Range("M" & RowToTest).Value, "Totaal", vbTextCompare) <> 1 Then
        Rows(RowToTest).EntireRow.Delete
    End If
Next
        
'sorteren aankopen
Worksheets("aankopen").Activate
lastRowAankopen = Cells(Rows.Count, "G").End(xlUp).Row

ActiveWorkbook.Worksheets("aankopen").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("aankopen").Sort.SortFields.Add Key:= _
        Range("J4:J" & lastRowAankopen), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption _
        :=xlSortNormal
    ActiveWorkbook.Worksheets("aankopen").Sort.SortFields.Add Key:= _
        Range("E4:E" & lastRowAankopen), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption _
        :=xlSortNormal
    With ActiveWorkbook.Worksheets("aankopen").Sort
        .SetRange Range("D3:K" & lastRowAankopen)
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    
End Sub
