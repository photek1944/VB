Option Explicit

Dim rng As Range
Dim lastRow As Long, totalCount As Long, pigeonCount As Long, expensiveCount As Long, Pcount As Long
Dim Cell As Object, client As Variant
Dim rowClientOccurance1 As Long, rowClientOccurance2 As Long, i As Long, remainder As Long
Dim counter As Long, nextStartingRow As Long, addRows As Long, subtractRows As Long

Sub Add_P_nrs()

lastRow = Cells(Rows.Count, "E").End(xlUp).Row
Range("A2:C" & lastRow).Value = ""

Dim colUnique As Collection
Set colUnique = New Collection

Set rng = Range("E2:E" & lastRow)
For Each Cell In rng
    On Error Resume Next
        colUnique.Add Cell, Cell
    On Error GoTo 0
Next Cell

[A1] = 0
For Each client In colUnique
    rowClientOccurance1 = Columns("E").Find(What:=client, LookAt:=xlWhole, MatchCase:=False).Row
    rowClientOccurance2 = Columns("E").Find(What:=client, LookAt:=xlWhole, SearchDirection:=xlPrevious, MatchCase:=False).Row
    Set rng = Range("E" & rowClientOccurance1 & ":E" & rowClientOccurance2)
    pigeonCount = Application.WorksheetFunction.CountIf(rng, client)
    Set rng = Range("D" & rowClientOccurance1 & ":D" & rowClientOccurance2)
    expensiveCount = 0
        For Each Cell In rng
            If Cell.Interior.Color = 65535 Then
                expensiveCount = expensiveCount + 1
            End If
        Next Cell
    totalCount = pigeonCount + expensiveCount
    
    Select Case totalCount
    
    Case 1 To 6, 8, 10, 12:
        Set rng = Range("A" & rowClientOccurance1 & ":A" & rowClientOccurance2)
            For Each Cell In rng
                If Cell.Offset(0, 4).Value = Cell.Offset(-1, 4).Value Then
                    Cell = Cell.Offset(-1, 0).Value
                Else
                    Cell = Pcount + 1
                    Pcount = Pcount + 1
                End If
            Next Cell
        If totalCount = 1 Then
            totalCount = totalCount + 1
        End If
        Range("B" & rowClientOccurance2).Value = totalCount
        Range("C" & rowClientOccurance2).Value = pigeonCount
        
    Case 7, 9, 11:
        subtractRows = Int(pigeonCount / 2)
        addRows = Int(pigeonCount / 2 + 0.999999)
        
        'basket part1
        rowClientOccurance1 = Columns("E").Find(What:=client, LookAt:=xlWhole, MatchCase:=False).Row
        rowClientOccurance2 = Columns("E").Find(What:=client, LookAt:=xlWhole, SearchDirection:=xlPrevious, MatchCase:=False).Row
        Set rng = Range("E" & rowClientOccurance1 & ":E" & rowClientOccurance2 - subtractRows)
        pigeonCount = Application.WorksheetFunction.CountIf(rng, client)
        Set rng = Range("D" & rowClientOccurance1 & ":D" & rowClientOccurance2 - subtractRows)
        expensiveCount = 0
            For Each Cell In rng
                If Cell.Interior.Color = 65535 Then
                    expensiveCount = expensiveCount + 1
                End If
            Next Cell
        totalCount = pigeonCount + expensiveCount
        Set rng = Range("A" & rowClientOccurance1 & ":A" & rowClientOccurance2 - subtractRows)
            For Each Cell In rng
                If Cell.Offset(0, 4).Value = Cell.Offset(-1, 4).Value Then
                    Cell = Cell.Offset(-1, 0).Value
                Else
                    Cell = Pcount + 1
                    Pcount = Pcount + 1
                End If
            Next Cell
        If totalCount = 1 Then
            totalCount = totalCount + 1
        End If
        Range("B" & rowClientOccurance2 - subtractRows).Value = totalCount
        Range("C" & rowClientOccurance2 - subtractRows).Value = pigeonCount
        
        'basket part 2
        rowClientOccurance1 = Columns("E").Find(What:=client, LookAt:=xlWhole, MatchCase:=False).Row
        rowClientOccurance2 = Columns("E").Find(What:=client, LookAt:=xlWhole, SearchDirection:=xlPrevious, MatchCase:=False).Row
        Set rng = Range("E" & rowClientOccurance1 + addRows & ":E" & rowClientOccurance2)
        pigeonCount = Application.WorksheetFunction.CountIf(rng, client)
        Set rng = Range("D" & rowClientOccurance1 + addRows & ":D" & rowClientOccurance2)
        expensiveCount = 0
            For Each Cell In rng
                If Cell.Interior.Color = 65535 Then
                    expensiveCount = expensiveCount + 1
                End If
            Next Cell
        totalCount = pigeonCount + expensiveCount
        Set rng = Range("A" & rowClientOccurance1 + addRows & ":A" & rowClientOccurance2)
        Pcount = Pcount + 1
            For Each Cell In rng
                Cell = Pcount
            Next Cell
        If totalCount = 1 Then
            totalCount = totalCount + 1
        End If
        Range("B" & rowClientOccurance2).Value = totalCount
        Range("C" & rowClientOccurance2).Value = pigeonCount

    Case Is > 12:
        i = pigeonCount \ 12
        remainder = pigeonCount - (i * 12)
    'calculate ranges per 12 pigeon baskets
         nextStartingRow = 0
        For counter = 1 To i
            rowClientOccurance1 = Columns("E").Find(What:=client, LookAt:=xlWhole, MatchCase:=False).Row + nextStartingRow
            Set rng = Range("E" & rowClientOccurance1 & ":E" & rowClientOccurance1 + 11)
            pigeonCount = Application.WorksheetFunction.CountIf(rng, client)
            nextStartingRow = nextStartingRow + 12
            Set rng = Range("D" & rowClientOccurance1 & ":D" & rowClientOccurance1 + 11)
            expensiveCount = 0
                For Each Cell In rng
                    If Cell.Interior.Color = 65535 Then
                        expensiveCount = expensiveCount + 1
                    End If
                Next Cell
            totalCount = pigeonCount + expensiveCount
                'if all pigeons fit into one 12 size basket:
                If totalCount = 12 Then
                    Set rng = Range("A" & rowClientOccurance1 & ":A" & rowClientOccurance1 + 11)
                    For Each Cell In rng
                        If Cell.Offset(-1, 1).Value = "" Then
                            Cell = Cell.Offset(-1, 0).Value
                        Else
                            Cell = Pcount + 1
                            Pcount = Pcount + 1
                        End If
                    Next Cell
                    If totalCount = 1 Then
                        totalCount = totalCount + 1
                    End If
                End If
                Range("B" & rowClientOccurance1 + 11).Value = totalCount
                Range("C" & rowClientOccurance1 + 11).Value = pigeonCount
                'if the pigeons do not fit into a 12 size basket:
                
         Next

    'fill up remainder basket
    End Select
Next client

[A1] = "P"
Pcount = 0

End Sub
